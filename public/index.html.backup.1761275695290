<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToList - å¾…åŠäº‹é¡¹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-box">
                <h1>ğŸ“‹ ToList</h1>
                <p class="login-subtitle">å¾…åŠäº‹é¡¹ç®¡ç†ç³»ç»Ÿ</p>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="username">ç”¨æˆ·å</label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            placeholder="è¾“å…¥ç”¨æˆ·å"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="password">å¯†ç </label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            placeholder="è¾“å…¥å¯†ç "
                            required
                        >
                    </div>

                    <div id="loginError" class="error-msg"></div>

                    <button type="submit" class="btn-login">ç™»å½•</button>
                </form>
            </div>
        </div>
    </div>

    <!-- åº”ç”¨ä¸»é¡µé¢ -->
    <div id="appPage" class="page">
        <div class="main-wrapper">
            <!-- å·¦ä¾§ï¼šå¾…åŠäº‹é¡¹åŒºåŸŸï¼ˆ2/3å®½åº¦ï¼‰ -->
            <div class="todo-container">
                <div class="header">
                    <div class="header-left">
                        <h1>ğŸ“‹ æˆ‘çš„å¾…åŠäº‹é¡¹</h1>
                        <p class="subtitle">è®°å½•ã€ç®¡ç†å’Œå®Œæˆä½ çš„ä»»åŠ¡</p>
                    </div>
                    <div class="header-right">
                        <span id="currentUser" class="user-info"></span>
                        <button id="logoutBtn" class="btn-logout">é€€å‡ºç™»å½•</button>
                    </div>
                </div>

                <!-- æ·»åŠ å¾…åŠäº‹é¡¹è¡¨å• -->
                <div class="add-todo-section">
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="todoInput" 
                            class="todo-input" 
                            placeholder="è¾“å…¥å¾…åšäº‹é¡¹..."
                            autocomplete="off"
                        >
                        <input 
                            type="datetime-local" 
                            id="todoDateTime" 
                            class="datetime-input"
                        >
                        <button id="addBtn" class="btn-add">+ æ·»åŠ </button>
                    </div>
                    <div id="errorMsg" class="error-msg"></div>
                    <div id="successMsg" class="success-msg"></div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-label">æ€»æ•°ï¼š</span>
                        <span id="totalCount" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¾…å®Œæˆï¼š</span>
                        <span id="pendingCount" class="stat-value">0</span>
                    </div>
                </div>

                <!-- å¾…åŠäº‹é¡¹åˆ—è¡¨ -->
                <div class="todo-list-section">
                    <div id="todoList" class="todo-list">
                        <div class="loading-state">
                            <p>â³ æ­£åœ¨åŠ è½½...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šAIèŠå¤©çª—å£ï¼ˆ1/3å®½åº¦ï¼‰ -->
            <div class="ai-chat-container">
                <div class="ai-chat-box">
                    <div class="ai-header">
                        <h2>ğŸ¤– AI åŠ©æ‰‹</h2>
                        <span class="ai-status" id="aiStatus">æœªè¿æ¥</span>
                    </div>

                    <!-- API Key è®¾ç½®é¢æ¿ -->
                    <div id="apiKeyPanel" class="api-key-panel">
                        <div class="api-key-content">
                            <h3>é…ç½® Gemini API</h3>
                            <p class="api-key-hint">
                                è¯·è¾“å…¥æ‚¨çš„ Gemini API Key
                            </p>
                            <p class="api-key-hint-small">
                                è·å– API Key: <a href="https://aistudio.google.com/app/apikey" target="_blank">https://aistudio.google.com/app/apikey</a>
                            </p>
                            <div class="api-key-input-group">
                                <input 
                                    type="password" 
                                    id="geminiApiKey" 
                                    class="api-key-input"
                                    placeholder="ç²˜è´´æ‚¨çš„ Gemini API Key..."
                                >
                                <button id="saveApiKeyBtn" class="btn-save-key">ä¿å­˜</button>
                            </div>
                            <div id="apiKeyError" class="api-key-error"></div>
                        </div>
                    </div>

                    <!-- èŠå¤©åŒºåŸŸ -->
                    <div id="chatArea" class="chat-area" style="display: none;">
                        <div id="chatMessages" class="chat-messages">
                            <div class="chat-message system">
                                <p>ğŸ‘‹ Hello! æˆ‘æ˜¯æ‚¨çš„ AI åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨ç®¡ç†å¾…åŠäº‹é¡¹ã€‚</p>
                            </div>
                        </div>

                        <div class="chat-input-area">
                            <div class="input-group-chat">
                                <input 
                                    type="text" 
                                    id="chatInput" 
                                    class="chat-input"
                                    placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
                                    autocomplete="off"
                                >
                                <button id="sendBtn" class="btn-send">å‘é€</button>
                            </div>
                            <div id="chatError" class="chat-error"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini API åº“åŠ è½½ (å¤šCDNå¤‡ç”¨æ–¹æ¡ˆ) -->
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai@0.3.0/dist/index.umd.js"></script>
    
    <!-- åº“åŠ è½½ç›‘æ§å’Œå¤‡ç”¨æ–¹æ¡ˆ -->
    <script>
        // æ£€æŸ¥Geminiåº“æ˜¯å¦åŠ è½½
        window.addEventListener('load', function() {
            let attempts = 0;
            const maxAttempts = 15;
            
            function checkAndLoadGemini() {
                if (window.GoogleGenerativeAI) {
                    console.log('âœ… Geminiåº“å·²åŠ è½½');
                    return;
                }
                
                attempts++;
                if (attempts <= 5) {
                    console.log(`â³ ç­‰å¾…Geminiåº“åŠ è½½... (${attempts}/${maxAttempts})`);
                    setTimeout(checkAndLoadGemini, 300);
                } else if (attempts <= maxAttempts) {
                    // å°è¯•å¤‡ç”¨CDN
                    console.log(`ğŸ“¡ å°è¯•å¤‡ç”¨CDNåŠ è½½Geminiåº“ (${attempts - 5})`);
                    loadGeminiFromBackup();
                    setTimeout(checkAndLoadGemini, 500);
                } else {
                    console.error('âŒ Geminiåº“åŠ è½½å¤±è´¥');
                    showGeminiError();
                }
            }
            
            function loadGeminiFromBackup() {
                // å°è¯•unpkg CDN
                if (attempts === 6) {
                    loadScriptFromCDN('https://unpkg.com/@google/generative-ai/dist/index.umd.js', 'unpkg');
                }
                // å°è¯•å…¶ä»–å¤‡ç”¨æº
                else if (attempts === 10) {
                    loadScriptFromCDN('https://cdn.jsdelivr.net/npm/@google/generative-ai@latest/dist/index.umd.js', 'jsDelivr latest');
                }
            }
            
            function loadScriptFromCDN(url, cdnName) {
                if (document.querySelector(`script[data-cdn="${cdnName}"]`)) {
                    return; // å·²ç»åœ¨åŠ è½½
                }
                
                const script = document.createElement('script');
                script.src = url;
                script.async = true;
                script.setAttribute('data-cdn', cdnName);
                script.onload = function() {
                    console.log(`âœ… ${cdnName} CDN åŠ è½½æˆåŠŸ`);
                };
                script.onerror = function() {
                    console.log(`âŒ ${cdnName} CDN åŠ è½½å¤±è´¥`);
                };
                document.head.appendChild(script);
            }
            
            function showGeminiError() {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fee2e2;
                    color: #991b1b;
                    padding: 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-weight: 600;
                    max-width: 600px;
                    text-align: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    border: 2px solid #fecaca;
                `;
                errorDiv.innerHTML = `
                    âš ï¸ <strong>Geminiåº“åŠ è½½å¤±è´¥</strong><br>
                    <small style="font-weight: normal; display: block; margin-top: 8px;">
                        è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢ã€‚å¦‚é—®é¢˜æŒç»­ï¼Œè¯·å°è¯•æ›´æ¢ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚<br>
                        <a href="javascript:location.reload()" style="color: inherit; text-decoration: underline; cursor: pointer;">åˆ·æ–°é¡µé¢</a>
                    </small>
                `;
                document.body.appendChild(errorDiv);
            }
            
            checkAndLoadGemini();
        });
    </script>
    
    <script src="script.js"></script>
</body>
</html>
