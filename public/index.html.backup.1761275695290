<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToList - 待办事项管理系统</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 登录页面 -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-box">
                <h1>📋 ToList</h1>
                <p class="login-subtitle">待办事项管理系统</p>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="username">用户名</label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            placeholder="输入用户名"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="password">密码</label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            placeholder="输入密码"
                            required
                        >
                    </div>

                    <div id="loginError" class="error-msg"></div>

                    <button type="submit" class="btn-login">登录</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 应用主页面 -->
    <div id="appPage" class="page">
        <div class="main-wrapper">
            <!-- 左侧：待办事项区域（2/3宽度） -->
            <div class="todo-container">
                <div class="header">
                    <div class="header-left">
                        <h1>📋 我的待办事项</h1>
                        <p class="subtitle">记录、管理和完成你的任务</p>
                    </div>
                    <div class="header-right">
                        <span id="currentUser" class="user-info"></span>
                        <button id="logoutBtn" class="btn-logout">退出登录</button>
                    </div>
                </div>

                <!-- 添加待办事项表单 -->
                <div class="add-todo-section">
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="todoInput" 
                            class="todo-input" 
                            placeholder="输入待做事项..."
                            autocomplete="off"
                        >
                        <input 
                            type="datetime-local" 
                            id="todoDateTime" 
                            class="datetime-input"
                        >
                        <button id="addBtn" class="btn-add">+ 添加</button>
                    </div>
                    <div id="errorMsg" class="error-msg"></div>
                    <div id="successMsg" class="success-msg"></div>
                </div>

                <!-- 统计信息 -->
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-label">总数：</span>
                        <span id="totalCount" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">待完成：</span>
                        <span id="pendingCount" class="stat-value">0</span>
                    </div>
                </div>

                <!-- 待办事项列表 -->
                <div class="todo-list-section">
                    <div id="todoList" class="todo-list">
                        <div class="loading-state">
                            <p>⏳ 正在加载...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：AI聊天窗口（1/3宽度） -->
            <div class="ai-chat-container">
                <div class="ai-chat-box">
                    <div class="ai-header">
                        <h2>🤖 AI 助手</h2>
                        <span class="ai-status" id="aiStatus">未连接</span>
                    </div>

                    <!-- API Key 设置面板 -->
                    <div id="apiKeyPanel" class="api-key-panel">
                        <div class="api-key-content">
                            <h3>配置 Gemini API</h3>
                            <p class="api-key-hint">
                                请输入您的 Gemini API Key
                            </p>
                            <p class="api-key-hint-small">
                                获取 API Key: <a href="https://aistudio.google.com/app/apikey" target="_blank">https://aistudio.google.com/app/apikey</a>
                            </p>
                            <div class="api-key-input-group">
                                <input 
                                    type="password" 
                                    id="geminiApiKey" 
                                    class="api-key-input"
                                    placeholder="粘贴您的 Gemini API Key..."
                                >
                                <button id="saveApiKeyBtn" class="btn-save-key">保存</button>
                            </div>
                            <div id="apiKeyError" class="api-key-error"></div>
                        </div>
                    </div>

                    <!-- 聊天区域 -->
                    <div id="chatArea" class="chat-area" style="display: none;">
                        <div id="chatMessages" class="chat-messages">
                            <div class="chat-message system">
                                <p>👋 Hello! 我是您的 AI 助手，可以帮助您管理待办事项。</p>
                            </div>
                        </div>

                        <div class="chat-input-area">
                            <div class="input-group-chat">
                                <input 
                                    type="text" 
                                    id="chatInput" 
                                    class="chat-input"
                                    placeholder="输入您的问题..."
                                    autocomplete="off"
                                >
                                <button id="sendBtn" class="btn-send">发送</button>
                            </div>
                            <div id="chatError" class="chat-error"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini API 库加载 (多CDN备用方案) -->
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai@0.3.0/dist/index.umd.js"></script>
    
    <!-- 库加载监控和备用方案 -->
    <script>
        // 检查Gemini库是否加载
        window.addEventListener('load', function() {
            let attempts = 0;
            const maxAttempts = 15;
            
            function checkAndLoadGemini() {
                if (window.GoogleGenerativeAI) {
                    console.log('✅ Gemini库已加载');
                    return;
                }
                
                attempts++;
                if (attempts <= 5) {
                    console.log(`⏳ 等待Gemini库加载... (${attempts}/${maxAttempts})`);
                    setTimeout(checkAndLoadGemini, 300);
                } else if (attempts <= maxAttempts) {
                    // 尝试备用CDN
                    console.log(`📡 尝试备用CDN加载Gemini库 (${attempts - 5})`);
                    loadGeminiFromBackup();
                    setTimeout(checkAndLoadGemini, 500);
                } else {
                    console.error('❌ Gemini库加载失败');
                    showGeminiError();
                }
            }
            
            function loadGeminiFromBackup() {
                // 尝试unpkg CDN
                if (attempts === 6) {
                    loadScriptFromCDN('https://unpkg.com/@google/generative-ai/dist/index.umd.js', 'unpkg');
                }
                // 尝试其他备用源
                else if (attempts === 10) {
                    loadScriptFromCDN('https://cdn.jsdelivr.net/npm/@google/generative-ai@latest/dist/index.umd.js', 'jsDelivr latest');
                }
            }
            
            function loadScriptFromCDN(url, cdnName) {
                if (document.querySelector(`script[data-cdn="${cdnName}"]`)) {
                    return; // 已经在加载
                }
                
                const script = document.createElement('script');
                script.src = url;
                script.async = true;
                script.setAttribute('data-cdn', cdnName);
                script.onload = function() {
                    console.log(`✅ ${cdnName} CDN 加载成功`);
                };
                script.onerror = function() {
                    console.log(`❌ ${cdnName} CDN 加载失败`);
                };
                document.head.appendChild(script);
            }
            
            function showGeminiError() {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fee2e2;
                    color: #991b1b;
                    padding: 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-weight: 600;
                    max-width: 600px;
                    text-align: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    border: 2px solid #fecaca;
                `;
                errorDiv.innerHTML = `
                    ⚠️ <strong>Gemini库加载失败</strong><br>
                    <small style="font-weight: normal; display: block; margin-top: 8px;">
                        请检查网络连接后刷新页面。如问题持续，请尝试更换网络或稍后重试。<br>
                        <a href="javascript:location.reload()" style="color: inherit; text-decoration: underline; cursor: pointer;">刷新页面</a>
                    </small>
                `;
                document.body.appendChild(errorDiv);
            }
            
            checkAndLoadGemini();
        });
    </script>
    
    <script src="script.js"></script>
</body>
</html>
